---
name: 'step-04-validate'
description: 'Run full test suite, validate FR coverage, generate build report'
stateFile: '{project_root}/build-state.json'
reportFile: '{project_root}/docs/build-report.md'
---

# Step 4: Validate

**Progress:** Step 4 of 4 - Final Step

**Goal:** Run full validation, assess FR coverage, and generate comprehensive build report.

---

## Execution Rules

- **Autonomous step** - no user prompts
- Run all validation checks
- Generate detailed build report
- Mark build complete (success or partial)

---

## Sequence (Follow Exactly)

### 1. Load Context

Read `{stateFile}` for:
- `completed_modules`
- `failed_modules`
- `prd_path`
- `architecture_path`
- `scaffold_status`

Load PRD for FR list and Architecture for validation targets.

---

### 2. Run Full Test Suite

Execute project test runner:

**Python:**
```bash
pytest --tb=short -v
```

**Node.js:**
```bash
npm test
```

Capture results:
- Total tests
- Passed
- Failed
- Skipped
- Coverage percentage (if available)

Output:
```
Test Results
============
Total: [N]
Passed: [N]
Failed: [N]
Skipped: [N]
Coverage: [N]%
```

---

### 3. Validate API Endpoints

From Architecture Section 5 (API Contracts):

For each endpoint, verify:
- Route file/handler exists
- Correct HTTP method
- Handler function implemented

Output:
```
API Validation
==============
Endpoints defined: [N]
Implemented: [N]
Missing: [list or "None"]
```

---

### 4. Validate Database

From Architecture Section 6 (Database Schema):

**Check tables/models exist:**
- For ORM: verify model files
- For raw SQL: verify migration files

**Check connections:**
- Attempt database connection
- Verify tables created

Output:
```
Database Validation
===================
Tables defined: [N]
Tables created: [N]
Connection: [OK/FAILED]
```

---

### 5. Calculate FR Coverage

Map implemented modules to FRs:

| FR ID | Title | Module | Status |
|-------|-------|--------|--------|
| FR-001 | [title] | [module] | Implemented |
| FR-002 | [title] | [module] | Implemented |
| FR-003 | [title] | [module] | Failed |
| FR-004 | [title] | - | Not Started |

Calculate:
- Total FRs from PRD
- FRs with implemented modules
- FRs with failed modules
- FRs not assigned to any module

Coverage = (Implemented / Total) * 100

Output:
```
FR Coverage
===========
Total FRs: [N]
Implemented: [N] ([%])
Failed: [N]
Unassigned: [N]
```

---

### 6. Generate Build Report

Create `{reportFile}` with structure:

```markdown
# Build Report

**Project:** [name]
**Date:** [timestamp]
**Duration:** [started_at to completed_at]
**Status:** [Complete/Partial]

---

## Summary

| Metric | Value |
|--------|-------|
| Modules | [completed]/[total] |
| Tests | [passed]/[total] |
| FR Coverage | [%] |
| API Endpoints | [implemented]/[defined] |

---

## Module Status

### Completed Modules

| Module | Location | FRs | Tests |
|--------|----------|-----|-------|
| [name] | [path] | [list] | [pass/fail] |

### Failed Modules

| Module | Error | Attempts |
|--------|-------|----------|
| [name] | [error summary] | [N] |

---

## FR Coverage Detail

| FR ID | Title | Status | Module |
|-------|-------|--------|--------|
| FR-001 | [title] | Implemented | [module] |
| FR-002 | [title] | Failed | [module] |

---

## Test Results

**Framework:** [pytest/jest/etc]
**Total:** [N] | **Passed:** [N] | **Failed:** [N]

### Failed Tests (if any)

| Test | Error |
|------|-------|
| [test name] | [error message] |

---

## Validation Results

### API Endpoints
[validation details]

### Database
[validation details]

### Environment
[validation details]

---

## Recommendations

[Auto-generated based on failures]

- Fix [module] to complete FR-XXX
- Address test failures in [area]
- Complete database migration for [table]

---

## Next Steps

1. Review failed modules and fix errors
2. Run `pytest` / `npm test` to verify fixes
3. Deploy or continue development

---

*Generated by build-from-prd workflow*
```

---

### 7. Update Final State

```json
{
  "status": "complete",
  "current_step": 4,
  "completed_at": "[ISO timestamp]",
  "test_results": {
    "passed": [N],
    "failed": [N],
    "skipped": [N]
  },
  "fr_coverage": [%],
  "validation": {
    "api": true/false,
    "database": true/false,
    "tests": true/false
  }
}
```

---

### 8. Final Output

```
=================================
Build Complete: [project_name]
=================================

Status: [Complete/Partial Success]

Modules: [N] completed, [N] failed
Tests: [N] passed, [N] failed
FR Coverage: [N]%

Report: docs/build-report.md

[If partial:]
Review build-report.md for failed modules and recommendations.

[If complete:]
Project is ready for testing and deployment.
```

---

## Success Criteria

- Full test suite executed
- API endpoints validated
- Database validated
- FR coverage calculated
- Build report generated at docs/build-report.md
- Final state saved with complete status
- Summary output displayed
